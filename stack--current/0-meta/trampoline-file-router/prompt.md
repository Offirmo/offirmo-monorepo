# TrampolineFileRouter

## Problem

On macOS, you can only set a **single default app per file type** (e.g., all `.ts` files open in Cursor). There's no built-in way to route files to different editors based on their **folder/path**.

## Solution

A lightweight macOS "trampoline" app that registers as the default handler for code file types. When a file is opened, it checks the file path against configurable rules and routes to the appropriate editor.

## How it works

1. TrampolineFileRouter is set as the default app for code file types (via `duti`)
2. When a file is opened (Finder double-click, `open` command, etc.), macOS launches TrampolineFileRouter
3. It reads `~/.config/trampoline-file-router/config.jsonc`
4. The file is matched against `rules` (first matching rule wins — by path, extension, or both)
5. The file is opened in the matched app, or `defaultApp` as fallback
6. TrampolineFileRouter quits silently (hidden from Dock via `LSUIElement`)

## Config

Located at `~/.config/trampoline-file-router/config.jsonc`:

```jsonc
{
  "defaultApp": "Cursor",
  "rules": [
    // Match by path only (~ and $HOME are expanded)
    { "pathPrefix": "~/work/src/x-external/off/offirmo", "app": "WebStorm" },
    // Match by extension only
    { "extensions": ["py", "pyw"], "app": "PyCharm" },
    // Match by both (AND logic)
    { "pathPrefix": "~/projects/rust", "extensions": ["rs", "toml"], "app": "RustRover" }
  ]
}
```

- `defaultApp`: fallback editor when no rule matches
- `rules`: ordered list, first matching rule wins
- `pathPrefix` (optional): match files whose path starts with this string (`~` and `$HOME` are expanded)
- `extensions` (optional): match files with one of these extensions (without dot)
- When both `pathPrefix` and `extensions` are present, both must match (AND logic)
- `app`: resolved by known bundle ID, then `/Applications/`, then `~/Applications/`

## Features

- **Path-based routing**: different editors for different folder trees
- **Extension-based routing**: route specific file types to specific editors (e.g., `.sql` → DataGrip)
- **Combined rules**: match by path AND extension together
- **x-ide:// URL scheme**: registered for future use (`x-ide:///path/to/file?line=42&col=10`)
- **Background app**: invisible (no Dock icon, no menu bar)
- **Logging**: all routing decisions logged to `~/.config/trampoline-file-router/trampoline-file-router.log`
- **Multi-file support**: groups files by target app when multiple files are opened at once
- **No-file launch**: opens the config directory if launched without files

## File types

Declared in `Info.plist`. The app *can* handle these, but only becomes the default for types set via `duti` in `register-extensions.sh`.

Currently in `register-extensions.sh`:
- TypeScript/JavaScript: `ts tsx js jsx mjs cjs mts cts`
- Web: `css scss sass less vue svelte astro`
- Config: `json json5 jsonc yaml yml toml xml`
- Shell: `sh bash zsh`
- Docs: `md mdx txt`
- Swift: `swift`
- Data: `sql graphql gql`

## Project structure

```
~/.local/share/trampoline-file-router/
├── prompt.md                  # This file — specs
├── src/
│   └── main.swift             # App source code
├── resources/
│   └── Info.plist             # App manifest (file types, x-ide:// scheme)
├── build-app-and-install.sh                 # Build & install to ~/Applications/
└── register-extensions.sh            # Snapshot current defaults into a restore script, then set TrampolineFileRouter via duti

~/.config/trampoline-file-router/
├── config.jsonc                # Routing rules
├── restore-previous-<date>.sh  # Self-contained restore script (generated by register-extensions.sh)
└── trampoline-file-router.log # Runtime logs

~/Applications/
└── TrampolineFileRouter.app   # Installed app bundle
```

## App resolution order

When resolving an app name (e.g., "WebStorm") to an actual app:
1. Look up in hardcoded `knownBundleIds` map → `NSWorkspace.urlForApplication(withBundleIdentifier:)`
2. Try `/Applications/<name>.app`
3. Try `~/Applications/<name>.app`
4. Show error alert if not found

## Install

```bash
bash ~/.local/share/trampoline-file-router/build-app-and-install.sh
bash ~/.local/share/trampoline-file-router/register-extensions.sh
```

## Revert

`register-extensions.sh` generates a self-contained restore script before making changes:
```bash
bash ~/.config/trampoline-file-router/restore-previous-2026-02-26-15_30.sh
```

Revert a single extension manually:
```bash
duti -s com.todesktop.230313mzl4w4u92 .ts all   # back to Cursor
```
